#!/bin/bash
# ============================================================ #
# ==                 –ú–û–î–£–õ–¨ –®–ï–ô–ü–ï–†–ê –¢–†–ê–§–ò–ö–ê                 == #
# ==                      VERSION 2.0                        == #
# ============================================================ #
#
# –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è
# –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é tc + u32 hashing (Stable Mode).
#
# –í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï:
#   v2.0 (28.12.2024) - –°—Ç—Ä–æ–≥–∏–µ –ª–∏–º–∏—Ç—ã: rate=ceil (burst 15k)
#                     - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
#   v1.0 (XX.12.2024) - –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º ceil
#
#  ( –†–û–î–ò–¢–ï–õ–¨ | –ö–õ–ê–í–ò–®–ê | –ù–ê–ó–í–ê–ù–ò–ï | –§–£–ù–ö–¶–ò–Ø | –ü–û–†–Ø–î–û–ö | –ì–†–£–ü–ü–ê | –û–ü–ò–°–ê–ù–ò–ï )
# @menu.manifest
#
# @item( main | 2 | üö¶ –®–µ–π–ø–µ—Ä —Ç—Ä–∞—Ñ–∏–∫–∞ ${C_GREEN}(–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç)${C_RESET} | show_traffic_limiter_menu | 2 | 0 | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–æ—Ä—Ç—É. )
#
# @item( traffic_limiter | 1 | üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–¢–æ–ø-5) | _tl_show_status | 10 | 1 | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ç–æ–ø –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π. )
# @item( traffic_limiter | 2 | ‚ûï –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç | _tl_apply_limit_wizard | 20 | 1 | –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ—Ä—Ç–∞. )
# @item( traffic_limiter | 3 | ‚ûñ –£–¥–∞–ª–∏—Ç—å –ª–∏–º–∏—Ç(—ã) | _show_delete_submenu | 30 | 1 | –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –≤—Å–µ –ª–∏–º–∏—Ç—ã. )
# @item( traffic_limiter | 4 | üìú –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥ —Å–µ—Ä–≤–∏—Å–∞ | _tl_view_service_log | 40 | 2 | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª –¥–ª—è —Å–ª—É–∂–±—ã —à–µ–π–ø–µ—Ä–∞. )
# @item( traffic_limiter | 5 | üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ (iftop) | _tl_monitor_traffic | 50 | 2 | –ó–∞–ø—É—Å–∫ —É—Ç–∏–ª–∏—Ç—ã iftop –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏. )
# @item( traffic_limiter | 6 | üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å (–°–±—Ä–æ—Å —Å—Ç–∞—Ç—ã) | _tl_restart_service | 60 | 2 | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –æ–±–Ω—É–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞. )
# @item( traffic_limiter | 7 | üíæ –ë—ç–∫–∞–ø / –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | _tl_backup_menu | 70 | 2 | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. )
#
# @item( traffic_limiter_delete | 1 | üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ª–∏–º–∏—Ç –¥–ª—è –ø–æ—Ä—Ç–∞ | _tl_clear_one_limit | 10 | 1 )
# @item( traffic_limiter_delete | 2 | ‚ò†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –ª–∏–º–∏—Ç—ã | _tl_clear_all_limits | 20 | 1 )
#


[[ "${BASH_SOURCE[0]}" == "${0}" ]] && exit 1 # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—É—Å–∫–∞


# –ü–æ–¥–∫–ª—é—á–∞–µ–º —è–¥—Ä–æ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
source "$SCRIPT_DIR/modules/core/common.sh"
source "$SCRIPT_DIR/modules/core/dependencies.sh"


# ============================================================ #
# ==                  –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø               == #
# ============================================================ #
#
# ‚öôÔ∏è –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–ó–ú–ï–ù–ï–ù–ò–Æ –ü–ê–†–ê–ú–ï–¢–†–û–í:
#
# 1. –ò–∑–º–µ–Ω–∏ –Ω—É–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∏–∂–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, TL_DL_BURST="20k")
# 2. –£–≤–µ–ª–∏—á—å TL_CONFIG_VERSION (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å "2" –Ω–∞ "3")
# 3. –ü–µ—Ä–µ–∑–∞–ª–µ–π —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –†–µ—à–∞–ª—ã –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –ø—Ä—è–º–æ —Ç–∞–º.
# 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –∫—Ä–∞—Å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
# 5. –ù–∞–∂–º–∏ 'u' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
#
# ============================================================ #

if [[ -z "${TL_CONFIG_DIR:-}" ]]; then
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ                   –ü–£–¢–ò –ò –°–ï–†–í–ò–°–´                        ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_CONFIG_DIR="/etc/reshala/traffic_limiter"
    # –ü–∞–ø–∫–∞ —Å –∫–æ–Ω—Ñ–∏–≥–∞–º–∏ –ø–æ—Ä—Ç–æ–≤ (port-8443.conf, port-443.conf, ...)
    
    readonly TL_BACKUP_DIR="/root/reshala_backups/traffic_limiter"
    # –ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
    
    readonly TL_APPLY_SCRIPT_PATH="/usr/local/bin/reshala-traffic-limiter-apply.sh"
    # –°–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ TC –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞
    
    readonly TL_SERVICE_NAME="reshala-traffic-limiter.service"
    readonly TL_SERVICE_PATH="/etc/systemd/system/${TL_SERVICE_NAME}"
    # Systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ                    –í–ï–†–°–ò–û–ù–ò–†–û–í–ê–ù–ò–ï                       ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_MODULE_VERSION="2.1"
    # –í–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ UI)
    # –£–≤–µ–ª–∏—á–∏–≤–∞–π –ø—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    
    readonly TL_CONFIG_VERSION="3"
    # ‚ö†Ô∏è –í–ê–ñ–ù–û: –£–≤–µ–ª–∏—á–∏–≤–∞–π —ç—Ç—É –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ TC!
    # –ü—Ä–∏–º–µ—Ä: –ï—Å–ª–∏ –º–µ–Ω—è–µ—à—å TL_DL_BURST="15k" –Ω–∞ "20k" ‚Äî —É–≤–µ–ª–∏—á—å –¥–æ "3"
    # –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ         –ü–ê–†–ê–ú–ï–¢–†–´ TC HTB (DOWNLOAD = –≤—Ö–æ–¥—è—â–∏–π)          ‚îÇ
    # ‚îÇ  –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –ö–ê–ñ–î–û–ú–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–¥–µ–ª—å–Ω–æ            ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_DL_RATE_MODE="strict"
    # –†–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏:
    #   - "strict"   : rate = ceil (—Å—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç, –Ω–µ–ª—å–∑—è –ø—Ä–µ–≤—ã—Å–∏—Ç—å)
    #   - "flexible" : rate < ceil (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–ª–æ—Å—É)
    # 
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: "strict" –¥–ª—è VPN (—á–µ—Å—Ç–Ω–∞—è —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è)
    # –§–û–†–ú–£–õ–ê strict: htb rate 5mbit ceil 5mbit  ‚Üí –º–∞–∫—Å–∏–º—É–º 5 Mbit/s
    # –§–û–†–ú–£–õ–ê flexible: htb rate 5mbit ceil 20mbit ‚Üí –º–æ–∂–µ—Ç –≤–∑—è—Ç—å –¥–æ 20 Mbit/s –µ—Å–ª–∏ –∫–∞–Ω–∞–ª –ø—É—Å—Ç–æ–π
    
    readonly TL_DL_BURST="20k"
    # –†–∞–∑–º–µ—Ä burst (–∫–æ—Ä–æ—Ç–∫–∏–π –≤—Å–ø–ª–µ—Å–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ rate)
    # –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –£–º–µ–Ω—å—à–∞–µ—Ç latency –¥–ª—è –º–µ–ª–∫–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ (DNS, ping, –ø–µ—Ä–≤—ã–µ TCP segments)
    # –†–ê–°–ß–Å–¢: rate / HZ * 2, –≥–¥–µ HZ = —á–∞—Å—Ç–æ—Ç–∞ —è–¥—Ä–∞ (–æ–±—ã—á–Ω–æ 250 –∏–ª–∏ 1000)
    #   –î–ª—è rate=5mbit, HZ=250: 5000000 / 250 / 8 * 2 = 5000 bytes = 5k
    #   –î–ª—è rate=20mbit:       20000000 / 250 / 8 * 2 = 20000 bytes = 20k
    # –¢–í–û–Ø –ù–ê–°–¢–†–û–ô–ö–ê 15k ‚Äî –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É 5k (rate) –∏ 20k (old ceil)
    # 
    # –ó–ù–ê–ß–ï–ù–ò–Ø:
    #   ""     ‚Üí burst –æ—Ç–∫–ª—é—á—ë–Ω
    #   "5k"   ‚Üí burst 5 –∫–∏–ª–æ–±–∞–π—Ç (—Å—Ç—Ä–æ–≥–æ –ø–æ rate)
    #   "15k"  ‚Üí burst 15 –∫–∏–ª–æ–±–∞–π—Ç (—É–º–µ—Ä–µ–Ω–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   "30k"  ‚Üí burst 30 –∫–∏–ª–æ–±–∞–π—Ç (–±–æ–ª—å—à–∏–µ –≤—Å–ø–ª–µ—Å–∫–∏)
    
    readonly TL_DL_CBURST=""
    # Cburst (burst –Ω–∞ —É—Ä–æ–≤–Ω–µ ceil, –¥–ª—è –º–∏–∫—Ä–æ–±—É—Ä—Å—Ç–æ–≤ –Ω–∞ wire speed)
    # –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ü–æ–∑–≤–æ–ª—è–µ—Ç –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—Å–ø–ª–µ—Å–∫–∏ –Ω–∞ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û–ô —Å–∫–æ—Ä–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–∞
    # –ö–û–ì–î–ê –ù–£–ñ–ï–ù: –¢–æ–ª—å–∫–æ –¥–ª—è flexible —Ä–µ–∂–∏–º–∞ (rate < ceil)
    # 
    # –ó–ù–ê–ß–ï–ù–ò–Ø:
    #   ""     ‚Üí cburst –æ—Ç–∫–ª—é—á—ë–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    #   "20k"  ‚Üí –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å flexible —Ä–µ–∂–∏–º —Å ceil > rate
    # 
    # ‚ö†Ô∏è –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô cburst –≤ strict —Ä–µ–∂–∏–º–µ (rate = ceil) ‚Äî –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ!
    
    readonly TL_DL_QUANTUM="1500"
    # Quantum = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–π—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –∑–∞ –æ–¥–∏–Ω "time slice"
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: 1500 –±–∞–π—Ç = MTU Ethernet (—Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞)
    # –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–´:
    #   1500  ‚Üí –æ–¥–∏–Ω –ø–∞–∫–µ—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   3000  ‚Üí –¥–≤–∞ –ø–∞–∫–µ—Ç–∞ (–¥–ª—è –≤—ã—Å–æ–∫–∏—Ö rate > 100 Mbit/s)
    #   ""    ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç: rate / 10 / 8
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ         –ü–ê–†–ê–ú–ï–¢–†–´ TC HTB (UPLOAD = –∏—Å—Ö–æ–¥—è—â–∏–π)           ‚îÇ
    # ‚îÇ  –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –ö–ê–ñ–î–û–ú–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–¥–µ–ª—å–Ω–æ            ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_UL_RATE_MODE="strict"
    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ TL_DL_RATE_MODE (—Å–º. –≤—ã—à–µ)
    
    readonly TL_UL_BURST=""
    # Upload burst ‚Äî –æ–±—ã—á–Ω–æ –ù–ï –ù–£–ñ–ï–ù –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
    # –ü–û–ß–ï–ú–£: Upload –∏–º–µ–µ—Ç –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä (ACK –ø–∞–∫–µ—Ç—ã, –Ω–µ–±–æ–ª—å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
    # –ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã
    # 
    # –ó–ù–ê–ß–ï–ù–ò–Ø:
    #   ""     ‚Üí burst –æ—Ç–∫–ª—é—á—ë–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   "10k"  ‚Üí –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –≤—Å–ø–ª–µ—Å–∫–∏ –¥–ª—è upload
    
    readonly TL_UL_CBURST=""
    # Upload cburst (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ TL_DL_CBURST)
    
    readonly TL_UL_QUANTUM="1500"
    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ TL_DL_QUANTUM
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ              –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ï –ö–õ–ê–°–°–´ (PORT)                 ‚îÇ
    # ‚îÇ  –û–±—â–∏–π –ª–∏–º–∏—Ç –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –ø–æ—Ä—Ç—É            ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_PARENT_QUANTUM="60000"
    # Quantum –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ (60 KB = ~40 –ø–∞–∫–µ—Ç–æ–≤)
    # –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –†–µ–≥—É–ª–∏—Ä—É–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞—Ñ–∏–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞ —Ä–∞–∑
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: –û—Å—Ç–∞–≤—å 60000 (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤)
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ                  –ü–ê–†–ê–ú–ï–¢–†–´ HASHING                       ‚îÇ
    # ‚îÇ  –û–ø—Ä–µ–¥–µ–ª—è—é—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ –ø–æ—Ä—Ç—É  ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_MAX_BUCKETS="256"
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –û–î–ù–û–ú –ø–æ—Ä—Ç—É
    # –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï: –°–æ–∑–¥–∞—ë—Ç—Å—è 256 "–∫–æ—Ä–∑–∏–Ω" (buckets), –∫—É–¥–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è IP –ø–æ —Ö–µ—à—É
    # 
    # –§–û–†–ú–£–õ–ê: –ü–∞–º—è—Ç—å –Ω–∞ –ø–æ—Ä—Ç ‚âà MAX_BUCKETS √ó 200 –±–∞–π—Ç ‚âà 51 KB –Ω–∞ –ø–æ—Ä—Ç
    # –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –ë–æ–ª—å—à–µ 256 –Ω–µ–ª—å–∑—è (–ª–∏–º–∏—Ç u32 hash table)
    # 
    # ‚ö†Ô∏è –ï–°–õ–ò –£ –¢–ï–ë–Ø > 256 –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ù–ê –ü–û–†–¢–£:
    #   - –ë—É–¥—É—Ç –∫–æ–ª–ª–∏–∑–∏–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ IP –≤ –æ–¥–Ω–æ–º bucket)
    #   - –≠—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –†–ê–ó–î–ï–õ–Ø–¢ –ª–∏–º–∏—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π
    #   - –ü—Ä–∏–º–µ—Ä: 2 IP –≤ bucket —Å –ª–∏–º–∏—Ç–æ–º 5 Mbit ‚Üí –∫–∞–∂–¥—ã–π –ø–æ–ª—É—á–∏—Ç ~2.5 Mbit
    
    readonly TL_HASH_DIVISOR="256"
    # –†–∞–∑–º–µ—Ä hash-—Ç–∞–±–ª–∏—Ü—ã (–î–û–õ–ñ–ï–ù –ë–´–¢–¨ = MAX_BUCKETS)
    # ‚ö†Ô∏è –ù–ï –ú–ï–ù–Ø–ô –í–†–£–ß–ù–£–Æ! –í—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π —Å TL_MAX_BUCKETS
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ            –ü–ê–†–ê–ú–ï–¢–†–´ SFQ (Fair Queuing)                 ‚îÇ
    # ‚îÇ  –ß–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–æ—Å—ã –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏            ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_SFQ_PERTURB="10"
    # –ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–∏ SFQ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
    # –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–ª–∏–∑–∏–∏ —Ö–µ—à–µ–π (–∫–æ–≥–¥–∞ —Ä–∞–∑–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–¥–Ω—É –æ—á–µ—Ä–µ–¥—å)
    # –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø: 10 —Å–µ–∫—É–Ω–¥ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
    # 
    # –ó–ù–ê–ß–ï–ù–ò–Ø:
    #   "10"  ‚Üí –ø–µ—Ä–µ–º–µ—à–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   "0"   ‚Üí –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ (–ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   ""    ‚Üí –æ—Ç–∫–ª—é—á–∏—Ç—å SFQ –ø–æ–ª–Ω–æ—Å—Ç—å—é (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pfifo –≤–º–µ—Å—Ç–æ sfq)
    
    readonly TL_SFQ_LIMIT=""
    # –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ SFQ (–≤ –ø–∞–∫–µ—Ç–∞—Ö)
    # –ó–ù–ê–ß–ï–ù–ò–Ø:
    #   ""     ‚Üí –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 127 –ø–∞–∫–µ—Ç–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    #   "64"   ‚Üí –º–∞–ª–µ–Ω—å–∫–∞—è –æ—á–µ—Ä–µ–¥—å (–º–µ–Ω—å—à–µ latency, –±–æ–ª—å—à–µ –ø–æ—Ç–µ—Ä—å)
    #   "256"  ‚Üí –±–æ–ª—å—à–∞—è –æ—á–µ—Ä–µ–¥—å (–±–æ–ª—å—à–µ bufferbloat)
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ                  –î–ï–§–û–õ–¢–ù–´–ï –õ–ò–ú–ò–¢–´                        ‚îÇ
    # ‚îÇ  –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –≤–∏–∑–∞—Ä–¥–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª        ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_DEFAULT_DOWN_RATE="4"
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ª–∏–º–∏—Ç –°–ö–ê–ß–ò–í–ê–ù–ò–Ø (–ú–±–∏—Ç/—Å) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ—Ä—Ç–∞
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –≤–∏–∑–∞—Ä–¥–µ
    
    readonly TL_DEFAULT_UP_RATE="4"
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ª–∏–º–∏—Ç –ó–ê–ì–†–£–ó–ö–ò (–ú–±–∏—Ç/—Å)
    
    readonly TL_DEFAULT_TOTAL_LIMIT="10000mbit"
    # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ª–∏–º–∏—Ç –ü–û–†–¢–ê (–º–∞–∫—Å–∏–º—É–º –¥–ª—è –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤ –≤–º–µ—Å—Ç–µ)
    # 10000mbit = 10 –ì–±–∏—Ç/—Å (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑–ª–∏–º–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤)
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ                   IFB –£–°–¢–†–û–ô–°–¢–í–û                         ‚îÇ
    # ‚îÇ  –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è UPLOAD           ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    readonly TL_IFB_DEVICE="ifb0"
    # –ò–º—è IFB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–µ –º–µ–Ω—è–π –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    # –ó–ê–ß–ï–ú: Linux –Ω–µ –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞–ø—Ä—è–º—É—é,
    #        –ø–æ—ç—Ç–æ–º—É –º—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π IFB –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    
    readonly TL_IFB_COUNT="1"
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ IFB —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ —Ö–≤–∞—Ç–∞–µ—Ç –æ–¥–Ω–æ–≥–æ)
    
    
    # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    # ‚îÇ         –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ (–ù–ï –¢–†–û–ì–ê–ô!)           ‚îÇ
    # ‚îÇ  –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏             ‚îÇ
    # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ DOWNLOAD
    _tl_build_param_signature() {
        local dl_params="rate"
        [[ "$TL_DL_RATE_MODE" == "strict" ]] && dl_params+=" ceil"
        [[ -n "$TL_DL_BURST" ]] && dl_params+=" burst"
        [[ -n "$TL_DL_CBURST" ]] && dl_params+=" cburst"
        [[ -n "$TL_DL_QUANTUM" ]] && dl_params+=" quantum"
        echo "$dl_params"
    }
    readonly TL_DL_PARAMS_SIGNATURE="$(_tl_build_param_signature)"
    # –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞: "rate ceil burst quantum"
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ UPLOAD
    _tl_build_ul_param_signature() {
        local ul_params="rate"
        [[ "$TL_UL_RATE_MODE" == "strict" ]] && ul_params+=" ceil"
        [[ -n "$TL_UL_BURST" ]] && ul_params+=" burst"
        [[ -n "$TL_UL_CBURST" ]] && ul_params+=" cburst"
        [[ -n "$TL_UL_QUANTUM" ]] && ul_params+=" quantum"
        echo "$ul_params"
    }
    readonly TL_UL_PARAMS_SIGNATURE="$(_tl_build_ul_param_signature)"
    # –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞: "rate ceil quantum"
fi


# ============================================================ #
# ==              HELPER: –ì–ï–ù–ï–†–ê–¶–ò–Ø HTB –ö–û–ú–ê–ù–î              == #
# ============================================================ #

_tl_generate_htb_class_cmd() {
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ HTB –∫–ª–∞—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: _tl_generate_htb_class_cmd "download|upload" "$RATE_LIMIT"
    local direction="$1"  # download | upload
    local rate="$2"       # –ù–∞–ø—Ä–∏–º–µ—Ä: 5mbit
    
    local cmd="htb rate \"$rate\""
    
    if [[ "$direction" == "download" ]]; then
        # Download –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if [[ "$TL_DL_RATE_MODE" == "strict" ]]; then
            cmd+=" ceil \"$rate\""
        else
            # –ì–∏–±–∫–∏–π —Ä–µ–∂–∏–º: –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å ceil –±–æ–ª—å—à–µ rate
            cmd+=" ceil \"${TL_DL_CEIL:-$rate}\""
        fi
        
        [[ -n "$TL_DL_BURST" ]] && cmd+=" burst $TL_DL_BURST"
        [[ -n "$TL_DL_CBURST" ]] && cmd+=" cburst $TL_DL_CBURST"
        [[ -n "$TL_DL_QUANTUM" ]] && cmd+=" quantum $TL_DL_QUANTUM"
        
    elif [[ "$direction" == "upload" ]]; then
        # Upload –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if [[ "$TL_UL_RATE_MODE" == "strict" ]]; then
            cmd+=" ceil \"$rate\""
        else
            cmd+=" ceil \"${TL_UL_CEIL:-$rate}\""
        fi
        
        [[ -n "$TL_UL_BURST" ]] && cmd+=" burst $TL_UL_BURST"
        [[ -n "$TL_UL_CBURST" ]] && cmd+=" cburst $TL_UL_CBURST"
        [[ -n "$TL_UL_QUANTUM" ]] && cmd+=" quantum $TL_UL_QUANTUM"
    fi
    
    echo "$cmd"
}

_tl_generate_sfq_cmd() {
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã SFQ
    local cmd="sfq"
    [[ -n "$TL_SFQ_PERTURB" ]] && cmd+=" perturb $TL_SFQ_PERTURB"
    [[ -n "$TL_SFQ_LIMIT" ]] && cmd+=" limit $TL_SFQ_LIMIT"
    echo "$cmd"
}


# ============================================================ #
# ==                      –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ                      == #
# ============================================================ #

show_traffic_limiter_menu() {
    ensure_package "tc" "iproute2"
    
    # 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤
    _tl_auto_repair_configs

    enable_graceful_ctrlc
    while true; do
        clear
        menu_header "üö¶ –®–µ–π–ø–µ—Ä —Ç—Ä–∞—Ñ–∏–∫–∞ (–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã) v${TL_MODULE_VERSION}"
        printf_description "–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –ö–ê–ñ–î–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        echo

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: —Å–º–æ—Ç—Ä–∏–º –∏ –Ω–∞ —Å–µ—Ä–≤–∏—Å, –∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
        local is_active="false"
        if systemctl is-active --quiet ${TL_SERVICE_NAME}; then is_active="true"; fi
        
        local config_count
        config_count=$(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null | wc -l)

        # === –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò (–î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–ê –í –ú–ï–ù–Æ) ===
        local outdated_count=0
        if [[ "$config_count" -gt 0 ]]; then
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
            local check_result
            check_result=$(_tl_check_rules_version 2>/dev/null)
            local check_exit_code=$?
            
            # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ —á–∏—Å–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if [[ -n "$check_result" && "$check_result" =~ ^[0-9]+$ ]]; then
                outdated_count="$check_result"
            # –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –∫–æ–¥ –æ—à–∏–±–∫–∏ 1 (–µ—Å—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ)
            elif [[ "$check_exit_code" -eq 1 ]]; then
                # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä—É—á–Ω—É—é
                outdated_count=$(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null | wc -l)
            fi
        fi

        local status_icon
        local update_indicator=""

        # –ï—Å–ª–∏ –µ—Å—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if [[ "$outdated_count" -gt 0 ]]; then
            update_indicator=" ${C_RED}üî¥${C_RESET}"
        fi

        if [[ "$is_active" == "true" && "$config_count" -gt 0 ]]; then
            status_icon="${C_GREEN}[‚úì –†–∞–±–æ—Ç–∞–µ—Ç: $config_count –ø–æ—Ä—Ç–æ–≤]${C_RESET}${update_indicator}"
        elif [[ "$config_count" -gt 0 ]]; then
            status_icon="${C_YELLOW}[‚ö† –ö–æ–Ω—Ñ–∏–≥–∏ –µ—Å—Ç—å, —Å–µ—Ä–≤–∏—Å —Å—Ç–æ–∏—Ç]${C_RESET}${update_indicator}"
        else
            status_icon="${C_GRAY}[‚àÖ –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω]${C_RESET}"
        fi
        
        printf_menu_option "1" "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–¢–æ–ø-5) ${status_icon}"
        printf_description "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ —Ç–æ–ø –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π."
        printf_menu_option "2" "‚ûï –î–æ–±–∞–≤–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç"
        printf_description "–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ—Ä—Ç–∞."
        printf_menu_option "3" "‚ûñ –£–¥–∞–ª–∏—Ç—å –ª–∏–º–∏—Ç(—ã)"
        printf_description "–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –≤—Å–µ –ª–∏–º–∏—Ç—ã."
        printf_menu_option "4" "üìú –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥ —Å–µ—Ä–≤–∏—Å–∞"
        printf_description "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª –¥–ª—è —Å–ª—É–∂–±—ã —à–µ–π–ø–µ—Ä–∞."
        printf_menu_option "5" "üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ (iftop)"
        printf_description "–ó–∞–ø—É—Å–∫ —É—Ç–∏–ª–∏—Ç—ã iftop –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏."
        printf_menu_option "6" "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å (–°–±—Ä–æ—Å —Å—Ç–∞—Ç—ã)"
        printf_description "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –æ–±–Ω—É–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞."
        printf_menu_option "7" "üíæ –ë—ç–∫–∞–ø / –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        printf_description "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."
        
        echo; printf_menu_option "b" "üîô –ù–∞–∑–∞–¥"; print_separator "-" 60

        local choice; choice=$(safe_read "–¢–≤–æ–π –≤—ã–±–æ—Ä") || break
        if [[ "$choice" == "b" || "$choice" == "B" ]]; then break; fi
        
        case "$choice" in
            1) _tl_show_status ;;
            2) _tl_apply_limit_wizard ;; 
            3) _show_delete_submenu ;; 
            4) _tl_view_service_log ;; 
            5) _tl_monitor_traffic ;;
            6) _tl_restart_service ;;
            7) _tl_backup_menu ;; 
            *) warn "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –ø—É–Ω–∫—Ç–∞." ;; 
        esac
        wait_for_enter
    done
    disable_graceful_ctrlc
}

_show_delete_submenu() {
    enable_graceful_ctrlc
    while true; do
        clear; menu_header "–£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤"; printf_description "–í—ã–±–µ—Ä–∏, –∫–∞–∫ –∏–º–µ–Ω–Ω–æ —Ç—ã —Ö–æ—á–µ—à—å —Å–Ω–µ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞."
        echo; render_menu_items "traffic_limiter_delete"
        echo; printf_menu_option "b" "üîô –ù–∞–∑–∞–¥"; print_separator "-" 60
        local choice; choice=$(safe_read "–¢–≤–æ–π –≤—ã–±–æ—Ä") || break
        if [[ "$choice" == "b" || "$choice" == "B" ]]; then break; fi
        local action; action=$(get_menu_action "traffic_limiter_delete" "$choice")
        if [[ -n "$action" ]]; then 
            eval "$action"
            wait_for_enter
        else 
            err "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –ø—É–Ω–∫—Ç–∞."
        fi
    done
    disable_graceful_ctrlc
}

# ============================================================ #
# ==                  –õ–û–ì–ò–ö–ê –ò –ü–û–î–ú–ï–ù–Æ                      == #
# ============================================================ #

_tl_backup_menu() {
    while true; do
        clear; menu_header "–ë—ç–∫–∞–ø –∏ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
        printf_description "–ü–∞–ø–∫–∞ –±—ç–∫–∞–ø–æ–≤: ${C_GRAY}${TL_BACKUP_DIR}${C_RESET}"
        echo
        printf_menu_option "1" "üíæ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"
        printf_menu_option "2" "üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞"
        echo; printf_menu_option "b" "üîô –ù–∞–∑–∞–¥"; print_separator "-" 60
        
        local choice; choice=$(safe_read "–¢–≤–æ–π –≤—ã–±–æ—Ä") || return
        if [[ "$choice" == "b" || "$choice" == "B" ]]; then return; fi
        
        case "$choice" in
            1)
                run_cmd mkdir -p "$TL_BACKUP_DIR"
                local filename="backup_$(date +%Y%m%d_%H%M%S).tar.gz"
                if run_cmd tar -czf "${TL_BACKUP_DIR}/${filename}" -C "${TL_CONFIG_DIR}" .; then
                    ok "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${filename}"
                else
                    err "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞."
                fi
                wait_for_enter
                ;;
            2)
                local backups=($(ls "${TL_BACKUP_DIR}"/*.tar.gz 2>/dev/null))
                if [[ ${#backups[@]} -eq 0 ]]; then
                    warn "–ë—ç–∫–∞–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
                else
                    local b_choice; b_choice=$(ask_selection "–í—ã–±–µ—Ä–∏—Ç–µ –±—ç–∫–∞–ø:" "${backups[@]}") || continue
                    local selected_backup="${backups[$((b_choice-1))]}"
                    
                    if ask_yes_no "–≠—Ç–æ –ó–ê–ú–ï–ù–ò–¢ –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"; then
                        run_cmd rm -rf "${TL_CONFIG_DIR:?}"/*
                        run_cmd tar -xzf "$selected_backup" -C "$TL_CONFIG_DIR"
                        ok "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å..."
                        _tl_restart_service
                    fi
                fi
                wait_for_enter
                ;;
        esac
    done
}

_tl_restart_service() {
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–º
    _tl_ensure_service_installed
    
    info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å —à–µ–π–ø–µ—Ä–∞..."
    run_cmd systemctl restart "${TL_SERVICE_NAME}"
    if systemctl is-active --quiet "${TL_SERVICE_NAME}"; then
        ok "–°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞."
    else
        err "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ."
    fi
}

_tl_monitor_traffic() {
    ensure_package "iftop"
    clear
    menu_header "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ (iftop)"
    
    printf_description "–í—ã–±–µ—Ä–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è:"
    local iface; iface=$(_tl_select_interface) || return

    info "–ó–∞–ø—É—Å–∫–∞—é iftop –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ ${C_CYAN}${iface}${C_RESET}..."
    info "–ù–∞–∂–º–∏ ${C_BOLD}q${C_RESET}, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ iftop."
    sleep 1
    
    run_cmd iftop -n -i "$iface"
}

_tl_auto_repair_configs() {
    if [[ ! -d "${TL_CONFIG_DIR}" ]]; then mkdir -p "${TL_CONFIG_DIR}"; return; fi
    local repaired=0
    while IFS= read -r file; do
        local changed=0
        if ! grep -q "MAX_USERS=" "$file"; then echo 'MAX_USERS="256"' >> "$file"; changed=1; fi
        if ! grep -q "TYPE=" "$file"; then echo 'TYPE="u32-hash"' >> "$file"; changed=1; fi
        if ! grep -q "TOTAL_LIMIT=" "$file"; then echo 'TOTAL_LIMIT="10000mbit"' >> "$file"; changed=1; fi
        
        if [[ "$changed" -eq 1 ]]; then ((repaired++)); fi
    done < <(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f)
    if [[ "$repaired" -gt 0 ]]; then debug_log "Auto-repaired $repaired config files."; fi
}

_tl_apply_limit_wizard() {
    clear; menu_header "–®–∞–≥ 1: –í—ã–±–æ—Ä —Å–µ—Ç–µ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
    printf_description "–í—ã–±–µ—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–æ–±—ã—á–Ω–æ ${C_YELLOW}eth0${C_RESET} –∏–ª–∏ ${C_YELLOW}ens...${C_RESET})"
    local iface; iface=$(_tl_select_interface) || { return; }

    clear; menu_header "–®–∞–≥ 2: –í—ã–±–æ—Ä –ø–æ—Ä—Ç–∞"
    _tl_show_listening_ports_smart; echo
    
    local port_choice; port_choice=$(safe_read "–í–≤–µ–¥–∏ –ø–æ—Ä—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é, –¥–∞–∂–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ)" "") || return
    local port;
    if [[ "$port_choice" =~ ^[0-9]+$ ]] && [ "$port_choice" -ge 1 ] && [ "$port_choice" -le 65535 ]; then
        port="$port_choice"
    else
        err "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ—Ä—Ç–∞. –í–≤–µ–¥–∏ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 65535."
        wait_for_enter
        return
    fi

    if [[ -f "${TL_CONFIG_DIR}/port-${port}.conf" ]]; then
        printf_critical_warning "–í–ù–ò–ú–ê–ù–ò–ï: –î–ª—è –ø–æ—Ä—Ç–∞ ${port} —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏–º–∏—Ç!"
        if ! ask_yes_no "–•–æ—á–µ—à—å –ü–ï–†–ï–ó–ê–ü–ò–°–ê–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? (y/n)" "n"; then warn "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."; return; fi
    fi

    clear; menu_header "–®–∞–≥ 3: –õ–∏–º–∏—Ç –Ω–∞ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø"
    local down_rate_num; down_rate_num=$(ask_number_in_range "–õ–∏–º–∏—Ç –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –Ω–∞ —é–∑–µ—Ä–∞ (–ú–±–∏—Ç/—Å)" 1 10000 "${TL_DEFAULT_DOWN_RATE}") || return
    local up_rate_num; up_rate_num=$(ask_number_in_range "–õ–∏–º–∏—Ç –ó–ê–ì–†–£–ó–ö–ò –Ω–∞ —é–∑–µ—Ä–∞ (–ú–±–∏—Ç/—Å)" 1 10000 "${TL_DEFAULT_UP_RATE}") || return

    clear; menu_header "–®–∞–≥ 4: –û–±—â–∏–π –ª–∏–º–∏—Ç –Ω–∞ –ü–û–†–¢"
    printf_description "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä—É—é –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å –í–°–ï —é–∑–µ—Ä—ã –≤–º–µ—Å—Ç–µ –≤–∑—è—Ç—ã–µ."
    printf_description "–û—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –∏–ª–∏ –≤–≤–µ–¥–∏ 0, —á—Ç–æ–±—ã –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å (–±—É–¥–µ—Ç 10 –ì–±–∏—Ç)."
    local total_rate_num; total_rate_num=$(safe_read "–û–±—â–∏–π –ª–∏–º–∏—Ç (–ú–±–∏—Ç/—Å) [–±–µ–∑–ª–∏–º–∏—Ç]" "")
    
    local total_limit="10000mbit"
    if [[ "$total_rate_num" =~ ^[0-9]+$ ]] && [ "$total_rate_num" -gt 0 ]; then
        total_limit="${total_rate_num}mbit"
    fi

    local down_limit="${down_rate_num}mbit"; local up_limit="${up_rate_num}mbit"

    clear; menu_header "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫"; 
    print_key_value "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å" "${C_CYAN}${iface}${C_RESET}" 28; 
    print_key_value "–ü–æ—Ä—Ç" "${C_CYAN}${port}${C_RESET}" 28; 
    print_key_value "–õ–∏–º–∏—Ç DL (User)" "${C_GREEN}${down_limit}${C_RESET}" 28; 
    print_key_value "–õ–∏–º–∏—Ç UL (User)" "${C_YELLOW}${up_limit}${C_RESET}" 28; 
    print_key_value "–õ–∏–º–∏—Ç –ü–û–†–¢–ê (Total)" "${C_RED}${total_limit}${C_RESET}" 28;
    print_key_value "–ú–∞–∫—Å. –∞–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤" "${C_CYAN}${TL_MAX_BUCKETS}${C_RESET}" 28;
    echo
    if ! ask_yes_no "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? (y/n)" "n"; then warn "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞."; return; fi

    info "–°–æ–∑–¥–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."; run_cmd mkdir -p "${TL_CONFIG_DIR}"
    cat << EOF | run_cmd tee "${TL_CONFIG_DIR}/port-${port}.conf" > /dev/null
IFACE="${iface}"
PORT="${port}"
DOWN_LIMIT="${down_limit}"
UP_LIMIT="${up_limit}"
TOTAL_LIMIT="${total_limit}"
MAX_USERS="${TL_MAX_BUCKETS}"
TYPE="u32-hash"
CONFIG_VERSION="${TL_CONFIG_VERSION}"
APPLIED_DL_PARAMS="${TL_DL_PARAMS_SIGNATURE}"
APPLIED_UL_PARAMS="${TL_UL_PARAMS_SIGNATURE}"
EOF
    info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∏ –∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å..."; _tl_ensure_service_installed; run_cmd systemctl restart "${TL_SERVICE_NAME}"
    
    sleep 2 # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
    if systemctl is-active --quiet "${TL_SERVICE_NAME}"; then 
        ok "–õ–∏–º–∏—Ç –¥–ª—è –ø–æ—Ä—Ç–∞ ${port} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω!"
    else 
        err "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å. –ü—Ä–æ–≤–µ—Ä—å 'journalctl -u ${TL_SERVICE_NAME}'"
        if ask_yes_no "–ü–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –∂—É—Ä–Ω–∞–ª –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞? (y/n)" "y"; then
            _tl_view_service_log
        fi
    fi
}

_tl_clear_one_limit() {
    if ! ls -A "${TL_CONFIG_DIR}"/*.conf >/dev/null 2>&1; then warn "–ê–∫—Ç–∏–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."; return; fi
    clear; menu_header "–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞"
    local options=(); local files=(); while IFS= read -r file; do if [[ -f "$file" ]]; then source "$file"; options+=("–ü–æ—Ä—Ç ${PORT} (${DOWN_LIMIT}/${UP_LIMIT}) –Ω–∞ ${IFACE}"); files+=("$file"); fi; done < <(find "${TL_CONFIG_DIR}" -name "port-*.conf")
    local choice; choice=$(ask_selection "–ê–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã:" "${options[@]}") || return
    local file_to_delete="${files[$((choice-1))]}"
    if ! ask_yes_no "–¢–æ—á–Ω–æ —Å–Ω–µ—Å—Ç–∏ —ç—Ç–æ—Ç –ª–∏–º–∏—Ç? (y/n)" "n"; then warn "–û—Ç–º–µ–Ω–∞."; return; fi
    info "–£–¥–∞–ª—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."; run_cmd rm -f "$file_to_delete"; run_cmd systemctl restart "${TL_SERVICE_NAME}"; ok "–õ–∏–º–∏—Ç —É–¥–∞–ª—ë–Ω."
}

_tl_clear_all_limits() {
    if ! ls -A "${TL_CONFIG_DIR}"/*.conf >/dev/null 2>&1; then warn "–ê–∫—Ç–∏–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ –Ω–µ—Ç."; return; fi
    if ! ask_yes_no "–¢–æ—á–Ω–æ —Å–Ω–µ—Å—Ç–∏ –í–°–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã?"; then warn "–û—Ç–º–µ–Ω–∞."; return; fi
    info "–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã—á–∏—â–∞—é –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞..."; _tl_uninstall_service; ok "–í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–Ω—è—Ç—ã."
}

# ============================================================ #
# ==          –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –ü–†–ê–í–ò–õ                  == #
# ============================================================ #

_tl_check_rules_version() {
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0 - –≤—Å–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ, 1 - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    local CURRENT_VERSION="${TL_CONFIG_VERSION}"
    local EXPECTED_DL_PARAMS="${TL_DL_PARAMS_SIGNATURE}"
    local EXPECTED_UL_PARAMS="${TL_UL_PARAMS_SIGNATURE}"
    
    local outdated_count=0
    local total_count=0
    local outdated_ports=()
    
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            source "$file"
            ((total_count++))
            
            local config_version="${CONFIG_VERSION:-1}"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ñ–∏–≥–∞
            if [[ "$config_version" -lt "$CURRENT_VERSION" ]]; then
                ((outdated_count++))
                outdated_ports+=("$PORT")
                continue
            fi
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
            if [[ "${APPLIED_DL_PARAMS:-}" != "$EXPECTED_DL_PARAMS" ]] || \
               [[ "${APPLIED_UL_PARAMS:-}" != "$EXPECTED_UL_PARAMS" ]]; then
                ((outdated_count++))
                outdated_ports+=("$PORT")
            fi
        fi
    done < <(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null)
    
    if [[ "$outdated_count" -gt 0 ]]; then
        echo "$outdated_count"
        return 1
    else
        return 0
    fi
}

_tl_upgrade_rules_auto() {
    clear
    menu_header "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª ‚Üí v${TL_CONFIG_VERSION}"
    
    info "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞:"
    echo
    _tl_get_outdated_details | while read -r line; do
        printf "  ${C_YELLOW}‚ö†${C_RESET} %s\n" "$line"
    done
    echo
    
    printf_description "–ë—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
    _tl_print_upgrade_preview
    echo
    
    if ! ask_yes_no "–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏? (y/n)" "n"; then
        warn "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
        return
    fi
    
    local updated=0
    local failed=0
    
    info "–û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            source "$file"
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
            if grep -q "CONFIG_VERSION=" "$file"; then
                sed -i "s|^CONFIG_VERSION=.*|CONFIG_VERSION=\"${TL_CONFIG_VERSION}\"|" "$file"
            else
                echo "CONFIG_VERSION=\"${TL_CONFIG_VERSION}\"" >> "$file"
            fi
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ DOWNLOAD
            if grep -q "APPLIED_DL_PARAMS=" "$file"; then
                sed -i "s|^APPLIED_DL_PARAMS=.*|APPLIED_DL_PARAMS=\"${TL_DL_PARAMS_SIGNATURE}\"|" "$file"
            else
                echo "APPLIED_DL_PARAMS=\"${TL_DL_PARAMS_SIGNATURE}\"" >> "$file"
            fi
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ UPLOAD
            if grep -q "APPLIED_UL_PARAMS=" "$file"; then
                sed -i "s|^APPLIED_UL_PARAMS=.*|APPLIED_UL_PARAMS=\"${TL_UL_PARAMS_SIGNATURE}\"|" "$file"
            else
                echo "APPLIED_UL_PARAMS=\"${TL_UL_PARAMS_SIGNATURE}\"" >> "$file"
            fi
            
            ((updated++))
            ok "–û–±–Ω–æ–≤–ª—ë–Ω –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø–æ—Ä—Ç–∞ ${PORT}"
        fi
    done < <(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null)
    
    echo
    info "–ü—Ä–∏–º–µ–Ω—è—é –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞..."
    if run_cmd systemctl restart "${TL_SERVICE_NAME}"; then
        ok "–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª: ${updated}"
        ok "–°–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        err "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–∏—Å–∞"
        ((failed++))
    fi
    
    if [[ "$failed" -eq 0 ]]; then
        ok "–í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –≤–µ—Ä—Å–∏–∏ ${TL_CONFIG_VERSION}!"
    else
        warn "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Å –æ—à–∏–±–∫–∞–º–∏"
    fi
}

_tl_print_upgrade_preview() {
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç preview –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    local dl_example="htb rate \$LIMIT"
    [[ "$TL_DL_RATE_MODE" == "strict" ]] && dl_example+=" ceil \$LIMIT"
    [[ -n "$TL_DL_BURST" ]] && dl_example+=" burst $TL_DL_BURST"
    [[ -n "$TL_DL_CBURST" ]] && dl_example+=" cburst $TL_DL_CBURST"
    [[ -n "$TL_DL_QUANTUM" ]] && dl_example+=" quantum $TL_DL_QUANTUM"
    
    local ul_example="htb rate \$LIMIT"
    [[ "$TL_UL_RATE_MODE" == "strict" ]] && ul_example+=" ceil \$LIMIT"
    [[ -n "$TL_UL_BURST" ]] && ul_example+=" burst $TL_UL_BURST"
    [[ -n "$TL_UL_CBURST" ]] && ul_example+=" cburst $TL_UL_CBURST"
    [[ -n "$TL_UL_QUANTUM" ]] && ul_example+=" quantum $TL_UL_QUANTUM"
    
    printf "  ${C_GREEN}‚Ä¢ Download:${C_RESET} %s\n" "$dl_example"
    printf "  ${C_YELLOW}‚Ä¢ Upload:${C_RESET}   %s\n" "$ul_example"
}

_tl_get_outdated_details() {
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–æ—Ä—Ç–æ–≤ —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏
    local CURRENT_VERSION="${TL_CONFIG_VERSION}"
    local EXPECTED_DL_PARAMS="${TL_DL_PARAMS_SIGNATURE}"
    local EXPECTED_UL_PARAMS="${TL_UL_PARAMS_SIGNATURE}"
    
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            source "$file"
            local config_version="${CONFIG_VERSION:-1}"
            local reason=""
            
            if [[ "$config_version" -lt "$CURRENT_VERSION" ]]; then
                reason="–≤–µ—Ä—Å–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ —É—Å—Ç–∞—Ä–µ–ª–∞ (v${config_version} ‚Üí v${CURRENT_VERSION})"
            elif [[ "${APPLIED_DL_PARAMS:-}" != "$EXPECTED_DL_PARAMS" ]]; then
                reason="–∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã HTB Download"
            elif [[ "${APPLIED_UL_PARAMS:-}" != "$EXPECTED_UL_PARAMS" ]]; then
                reason="–∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã HTB Upload"
            fi
            
            if [[ -n "$reason" ]]; then
                echo "–ü–æ—Ä—Ç ${PORT}: ${reason}"
            fi
        fi
    done < <(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null)
}

_tl_show_status() {
    clear
    menu_header "–°—Ç–∞—Ç—É—Å —à–µ–π–ø–µ—Ä–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ (Config v${TL_CONFIG_VERSION})"
    
    local config_count
    config_count=$(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f 2>/dev/null | wc -l)

    if [[ "$config_count" -eq 0 ]]; then 
        warn "–®–µ–π–ø–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)."
        return
    fi

    # === –ü–†–û–í–ï–†–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–ò –ü–†–ê–í–ò–õ ===
    local outdated_count
    outdated_count=$(_tl_check_rules_version) || true
    
    if [[ -n "$outdated_count" && "$outdated_count" -gt 0 ]]; then
        printf "${C_RED}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${C_RESET}\n"
        printf "${C_RED}‚îÇ  ‚ö†Ô∏è  –î–û–°–¢–£–ü–ù–û –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–ê–í–ò–õ TC (${outdated_count} –ø–æ—Ä—Ç–æ–≤)        ‚îÇ${C_RESET}\n"
        printf "${C_RED}‚îÇ  –ù–∞–∂–º–∏ '${C_BOLD}u${C_RESET}${C_RED}' –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è            ‚îÇ${C_RESET}\n"
        printf "${C_RED}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${C_RESET}\n"
        echo
    fi

    local is_active; is_active=$(systemctl is-active --quiet ${TL_SERVICE_NAME} && echo "true" || echo "false")
    
    local status_str
    if [[ "$is_active" == "true" ]]; then
        status_str="${C_GREEN}–ê–ö–¢–ò–í–ï–ù${C_RESET}"
    else
        status_str="${C_RED}–ù–ï –ê–ö–¢–ò–í–ï–ù${C_RESET}"
    fi
    print_key_value "–°–µ—Ä–≤–∏—Å systemd" "$status_str" 20
    echo

    print_section_title "–ê–ö–¢–ò–í–ù–´–ï –õ–ò–ú–ò–¢–´"
    local port_idx=1
    while IFS= read -r file; do 
        if [[ -f "$file" ]]; then 
            source "$file"
            
            # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
            local outdated_mark=""
            local config_version="${CONFIG_VERSION:-1}"
            if [[ "$config_version" -lt "${TL_CONFIG_VERSION}" ]] || \
               [[ "${APPLIED_DL_PARAMS:-}" != "${TL_DL_PARAMS_SIGNATURE}" ]] || \
               [[ "${APPLIED_UL_PARAMS:-}" != "${TL_UL_PARAMS_SIGNATURE}" ]]; then
                outdated_mark=" ${C_RED}[v${config_version} ‚Üí —É—Å—Ç–∞—Ä–µ–ª]${C_RESET}"
            fi
            
            printf "  - –ü–æ—Ä—Ç ${C_YELLOW}%-5s${C_RESET}: ${C_GREEN}%-8s${C_RESET} DL / ${C_YELLOW}%-8s${C_RESET} UL –Ω–∞ ${C_CYAN}%s${C_RESET}%s\n" \
                "$PORT" "$DOWN_LIMIT" "$UP_LIMIT" "$IFACE" "$outdated_mark"
            
            if [[ "${TOTAL_LIMIT:-10000mbit}" != "10000mbit" ]]; then
                printf "    ${C_RED}‚ö† –û–±—â–∏–π –ª–∏–º–∏—Ç –ø–æ—Ä—Ç–∞: %s${C_RESET}\n" "$TOTAL_LIMIT"
            fi
            
            if [[ "$is_active" == "true" ]]; then
                local dl_parent_class="1:$(printf "%x" $((port_idx * 16)))"
                
                local stats
                stats=$(tc -s class show dev "$IFACE" | grep -A 1 "class htb ${dl_parent_class} " | grep "Sent")
                if [[ -n "$stats" ]]; then
                    local rus_stats
                    rus_stats=$(echo "$stats" | awk '{
                        bytes=$2; pkts=$4; dropped=$7;
                        gsub(/,/, "", dropped);
                        printf "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: %s –±–∞–π—Ç, –ü–∞–∫–µ—Ç–æ–≤: %s, –ü–æ—Ç–µ—Ä—å: %s", bytes, pkts, dropped
                    }')
                    printf "    ‚Ü≥ ${C_GRAY}–í—Å–µ–≥–æ: %s${C_RESET}\n" "$rus_stats"
                else
                    printf "    ‚Ü≥ ${C_GRAY}(–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞—Ñ–∏–∫–µ)${C_RESET}\n"
                fi

                printf "    ‚Ü≥ ${C_BOLD}–¢–æ–ø-5 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ (Buckets):${C_RESET}\n"
                
                local top_users
                top_users=$(tc -s class show dev "$IFACE" | \
                    awk -v parent="${dl_parent_class}" ' 
                        $1=="class" && $2=="htb" && $4=="parent" && $5==parent {
                            current_id=$3
                        }
                        $1=="Sent" && current_id!="" {
                            print current_id, $2
                            current_id=""
                        }
                    ' | sort -k2 -nr | head -n 5)
                
                if [[ -n "$top_users" ]]; then
                    while read -r class_id bytes; do
                        local human_bytes
                        human_bytes=$(numfmt --to=iec-i --suffix=B "$bytes" 2>/dev/null || echo "${bytes} B")
                        printf "      ‚Ä¢ –ü–æ—Ç–æ–∫ ${C_CYAN}%-8s${C_RESET}: ${C_YELLOW}%s${C_RESET}\n" "$class_id" "$human_bytes"
                    done <<< "$top_users"
                else
                    printf "      ${C_GRAY}(–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)${C_RESET}\n"
                fi
            fi
            echo ""
            ((port_idx++))
        fi
    done < <(find "${TL_CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f | sort)
    
    # === –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î ===
    echo
    if [[ -n "$outdated_count" && "$outdated_count" -gt 0 ]]; then
        printf_description "–ù–∞–∂–º–∏ ${C_BOLD}u${C_RESET} –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª, ${C_BOLD}Enter${C_RESET} –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞"
        local user_choice; user_choice=$(safe_read "" "") || return
        
        if [[ "$user_choice" == "u" || "$user_choice" == "U" ]]; then
            _tl_upgrade_rules_auto
            wait_for_enter
            _tl_show_status  # –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        fi
    else
        if [[ "$is_active" == "false" ]]; then 
            if ask_yes_no "–°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω, —Ö–æ—Ç—è –∫–æ–Ω—Ñ–∏–≥–∏ –µ—Å—Ç—å! –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å? (y/n)" "n"; then 
                _tl_restart_service
            fi
        fi
    fi
}

_tl_view_service_log() {
    if ! [[ -f "${TL_SERVICE_PATH}" ]]; then
        warn "–°–µ—Ä–≤–∏—Å —à–µ–π–ø–µ—Ä–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –õ–æ–≥ –ø—É—Å—Ç."
        return
    fi
    info "–°–º–æ—Ç—Ä—é –ª–æ–≥ –¥–ª—è ${TL_SERVICE_NAME}... (–ù–∞–∂–º–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞)"
    echo
    journalctl -u ${TL_SERVICE_NAME} --no-pager -n 50
}

_tl_handle_legacy_cleanup() { 
    clear; menu_header "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —à–µ–π–ø–µ—Ä–∞"
    if ! ask_yes_no "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—É—é –∑–∞—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏. –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å–µ–π—á–∞—Å? (y/n)"; then 
        err "–û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."; wait_for_enter; return
    fi
    info "–ù–∞—á–∏–Ω–∞—é –∑–∞—á–∏—Å—Ç–∫—É..."
    run_cmd systemctl disable --now "${TL_SERVICE_NAME}" 2>/dev/null || true
    run_cmd rm -f "${TL_SERVICE_PATH}" "/usr/local/bin/reshala-traffic-limiter.sh"
    run_cmd systemctl daemon-reload
    
    local ifaces; ifaces=$(ip -o link show up | awk -F': ' '{print $2}' | grep -v '^lo$')
    for iface in $ifaces; do 
        run_cmd tc qdisc del dev "$iface" root 2>/dev/null || true
        run_cmd tc qdisc del dev "$iface" ingress 2>/dev/null || true
    done
    run_cmd tc qdisc del dev ifb0 root 2>/dev/null || true
    
    ok "–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —É–¥–∞–ª–µ–Ω–∞."
    wait_for_enter
}

_tl_select_interface() { local interfaces; mapfile -t interfaces < <(ip -o link show up | awk -F': ' '{print $2}' | grep -v '^lo$'); if [[ ${#interfaces[@]} -eq 0 ]]; then err "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤."; return 1; fi; >&2 info "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:"; local i=1; for iface_name in "${interfaces[@]}"; do >&2 printf "   [%d] %s\n" "$i" "$iface_name"; ((i++)); done; local choice; choice=$(ask_number_in_range "–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä" 1 ${#interfaces[@]}) || return 1; echo "${interfaces[$((choice-1))]}"; }

_tl_show_listening_ports_smart() {
    ensure_package "ss" "iproute2"
    info "–°–∫–∞–Ω–∏—Ä—É—é –æ—Ç–∫—Ä—ã—Ç—ã–µ TCP –ø–æ—Ä—Ç—ã..."
    local temp_file; temp_file=$(mktemp)
    
    while read -r line; do
        local listen_addr; listen_addr=$(echo "$line" | awk '{print $4}')
        local process_info; process_info=$(echo "$line" | awk '{$1=$2=$3=$4=$5=""; print $0}' | xargs)
        local port; port=$(echo "$listen_addr" | awk -F: '{print $NF}')
        [[ "$port" =~ ^[0-9]+$ ]] || continue
        
        local bind_addr_full
        bind_addr_full=$(echo "$listen_addr" | sed 's/:[^:]*$//')
        local bind_addr
        bind_addr=$(echo "$bind_addr_full" | sed 's/\[//g; s/]//g; s/%.*//' | xargs)
        
        local type_str="SPECIFIC"; local sort_key=3
        if [[ "$bind_addr" == "127.0.0.1" || "$bind_addr" == "::1" || "$bind_addr" == "localhost" || "$bind_addr" =~ ^127\.0\.0\.[0-9]+$ ]]; then
            type_str="${C_YELLOW}LOCAL${C_RESET}"; sort_key=3
        elif [[ "$bind_addr" == "*" || "$bind_addr" == "0.0.0.0" || "$bind_addr" == "::" ]]; then
            type_str="${C_GREEN}EXTERNAL${C_RESET}"; sort_key=2
        else
             type_str="${C_CYAN}SPECIFIC (${bind_addr})${C_RESET}"; sort_key=3
        fi
        local proc_str="N/A"
        if [[ "$process_info" == *"docker-proxy"* ]]; then
            proc_str="${C_BLUE}üê≥ Docker${C_RESET}"
        elif [[ "$process_info" == *"users"* ]]; then
            proc_str=$(echo "$process_info" | grep -oP '(?<=").+?(?=",)' | head -1)
            if [[ "$proc_str" == "xray" && "$sort_key" == "2" ]]; then sort_key="1"; fi
        fi
        local shaper_mark=""
        if [[ -f "${TL_CONFIG_DIR}/port-${port}.conf" ]]; then shaper_mark="${C_RED}–î–ê${C_RESET}"; fi
        printf "%s|%s|%s|%s|%s\n" "$sort_key" "$port" "$type_str" "$proc_str" "$shaper_mark" >> "$temp_file"
    done < <(ss -tlpn 2>/dev/null | awk '$1 == "LISTEN"')

    printf "\n   %-10s %-25s %-20s %s\n" "–ü–æ—Ä—Ç" "–°—Ç–∞—Ç—É—Å" "–ü—Ä–æ—Ü–µ—Å—Å" "–õ–∏–º–∏—Ç"
    printf "   %-10s %-25s %-20s %s\n" "----------" "-------------------------" "--------------------" "--------"
    sort -t'|' -k1,1n -k2,2n "$temp_file" | while IFS="|" read -r _sort_key port type_str proc_str shaper_mark; do
        printf "   %-10s %-25b %-20b %b\n" "$port" "$type_str" "$proc_str" "$shaper_mark"
    done
    rm -f "$temp_file"
    echo
    printf_description "${C_GRAY}(EXTERNAL: —Å–æ –≤—Å–µ—Ö IP, LOCAL: —Ç–æ–ª—å–∫–æ —Å 127.0.0.1, SPECIFIC: —Ç–æ–ª—å–∫–æ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ IP)${C_RESET}"
}

_tl_ensure_service_installed() { 
    info "–°–æ–∑–¥–∞—é/–æ–±–Ω–æ–≤–ª—è—é —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª..."
    _tl_generate_master_apply_script | run_cmd tee "${TL_APPLY_SCRIPT_PATH}" > /dev/null
    run_cmd chmod +x "${TL_APPLY_SCRIPT_PATH}"

    if [[ ! -f "${TL_SERVICE_PATH}" ]]; then 
        info "–°–æ–∑–¥–∞—é systemd —Å–µ—Ä–≤–∏—Å..."
        _tl_generate_systemd_service | run_cmd tee "${TL_SERVICE_PATH}" > /dev/null
        run_cmd systemctl daemon-reload
        run_cmd systemctl enable "${TL_SERVICE_NAME}"
    fi
}

_tl_uninstall_service() { 
    run_cmd systemctl disable --now "${TL_SERVICE_NAME}" 2>/dev/null || true
    run_cmd rm -f "${TL_SERVICE_PATH}" "${TL_APPLY_SCRIPT_PATH}"
    run_cmd rm -rf "${TL_CONFIG_DIR}"
    run_cmd systemctl daemon-reload
    
    local ifaces; ifaces=$(ip -o link show up | awk -F': ' '{print $2}' | grep -v '^lo$')
    for iface in $ifaces; do 
        run_cmd tc qdisc del dev "$iface" root 2>/dev/null || true
        run_cmd tc qdisc del dev "$iface" ingress 2>/dev/null || true
    done
    run_cmd tc qdisc del dev ifb0 root 2>/dev/null || true
}

# ============================================================ #
# ==           –ì–ï–ù–ï–†–ê–¢–û–† –°–ö–†–ò–ü–¢–ê –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø (U32 MODE)      == #
# ============================================================ #

_tl_generate_master_apply_script() {
    cat << EOF
#!/bin/bash
set -u
readonly CONFIG_DIR="/etc/reshala/traffic_limiter"
readonly IFB_DEV="ifb0"

# === –ü–ê–†–ê–ú–ï–¢–†–´ TC (–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ò–ó –ú–û–î–£–õ–Ø) ===
readonly DLRATEMODE="${TL_DL_RATE_MODE}"
readonly DLBURST="${TL_DL_BURST}"
readonly DLCBURST="${TL_DL_CBURST}"
readonly DLQUANTUM="${TL_DL_QUANTUM}"

readonly ULRATEMODE="${TL_UL_RATE_MODE}"
readonly ULBURST="${TL_UL_BURST}"
readonly ULCBURST="${TL_UL_CBURST}"
readonly ULQUANTUM="${TL_UL_QUANTUM}"

readonly PARENTQUANTUM="${TL_PARENT_QUANTUM}"
readonly SFQPERTURB="${TL_SFQ_PERTURB}"
readonly SFQLIMIT="${TL_SFQ_LIMIT}"

log() { echo "[\$(date '+%H:%M:%S')] - \$1"; }

run_tc() {
    local cmd="\$*"
    local out
    if ! out=\$(\$cmd 2>&1); then
        log "‚ùå \$cmd"
        log "   –û—Ç–≤–µ—Ç: \$out"
        exit 1
    fi
}

# === HELPER: –ì–ï–ù–ï–†–ê–¶–ò–Ø HTB –ü–ê–†–ê–ú–ï–¢–†–û–í ===
generate_htb_params() {
    local direction="$1"
    local rate="$2"
    
    local params="htb rate $rate"
    
    if [[ "$direction" == "download" ]]; then
        [[ "$DLRATEMODE" == "strict" ]] && params+=" ceil $rate"
        [[ -n "$DLBURST" ]] && params+=" burst $DLBURST"
        [[ -n "$DLCBURST" ]] && params+=" cburst $DLCBURST"
        [[ -n "$DLQUANTUM" ]] && params+=" quantum $DLQUANTUM"
    else
        [[ "$ULRATEMODE" == "strict" ]] && params+=" ceil $rate"
        [[ -n "$ULBURST" ]] && params+=" burst $ULBURST"
        [[ -n "$ULCBURST" ]] && params+=" cburst $ULCBURST"
        [[ -n "$ULQUANTUM" ]] && params+=" quantum $ULQUANTUM"
    fi
    
    echo "$params"
}

generate_sfq_params() {
    local params="sfq"
    [[ -n "$SFQPERTURB" ]] && params+=" perturb $SFQPERTURB"
    [[ -n "$SFQLIMIT" ]] && params+=" limit $SFQLIMIT"
    echo "$params"
}


log "üöÄ –ó–∞–ø—É—Å–∫ Reshala Traffic Limiter (U32 Hash Mode)..."


# === –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò HTB ===
if ! tc qdisc add dev lo root handle 999: htb &>/dev/null; then
    KERNEL_VERSION=$(uname -r)
    log "‚ö†Ô∏è –ú–æ–¥—É–ª—å sch_htb –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —è–¥—Ä–µ: $KERNEL_VERSION"
    log "–ü—ã—Ç–∞—é—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª–∏..."
    
    if [[ -f /etc/os-release ]]; then
        source /etc/os-release
        if [[ "$ID" == "debian" ]]; then
            log "–û–±–Ω–∞—Ä—É–∂–µ–Ω Debian. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –º–æ–¥—É–ª–∏..."
            apt update &>/dev/null
            apt install -y linux-image-$(uname -r) &>/dev/null || \
            apt install -y linux-image-amd64 &>/dev/null
        elif [[ "$ID" == "ubuntu" ]]; then
            log "–û–±–Ω–∞—Ä—É–∂–µ–Ω Ubuntu. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –º–æ–¥—É–ª–∏..."
            apt update &>/dev/null
            apt install -y linux-modules-extra-$(uname -r) &>/dev/null
        fi
    fi
    
    modprobe sch_htb &>/dev/null || true
    
    if ! tc qdisc add dev lo root handle 999: htb &>/dev/null; then
        log "‚ùå –û–®–ò–ë–ö–ê: HTB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
        log ""
        log "–¢–µ–∫—É—â–µ–µ —è–¥—Ä–æ: $KERNEL_VERSION"
        
        if zcat /proc/config.gz 2>/dev/null | grep -q "CONFIG_NET_SCH_HTB is not set"; then
            log "–ü—Ä–∏—á–∏–Ω–∞: HTB –≤—ã–∫–ª—é—á–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —è–¥—Ä–∞"
        elif [[ ! -d "/lib/modules/$KERNEL_VERSION/kernel/net/sched" ]]; then
            log "–ü—Ä–∏—á–∏–Ω–∞: –ú–æ–¥—É–ª–∏ TC –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è —ç—Ç–æ–≥–æ —è–¥—Ä–∞"
        fi
        
        log ""
        log "–†–ï–®–ï–ù–ò–ï –¥–ª—è Debian:"
        log "  1. –£—Å—Ç–∞–Ω–æ–≤–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —è–¥—Ä–æ:"
        log "     apt update && apt install -y linux-image-amd64"
        log "  2. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Å—å: reboot"
        log "  3. –í—ã–±–µ—Ä–∏ –Ω–æ–≤–æ–µ —è–¥—Ä–æ –≤ GRUB"
        log "  4. –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞"
        log ""
        log "–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —è–¥—Ä–æ (BBR3):"
        log "  - –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏ —Å CONFIG_NET_SCH_HTB=m"
        exit 1
    fi
fi
tc qdisc del dev lo root &>/dev/null || true
log "‚úÖ –ú–æ–¥—É–ª—å HTB –¥–æ—Å—Ç—É–ø–µ–Ω"


# –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π
modprobe ifb numifbs=1 &>/dev/null || true
modprobe sch_htb &>/dev/null || true
modprobe sch_sfq &>/dev/null || true
modprobe cls_u32 &>/dev/null || true
modprobe act_mirred &>/dev/null || true


# 1. –û—á–∏—Å—Ç–∫–∞
log "üßπ –û—á–∏—â–∞—é —Å—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞..."
ip -o link show up | awk -F': ' '{print $2}' | grep -v '^lo$' | while read -r iface; do
    tc qdisc del dev "$iface" root &>/dev/null || true
    tc qdisc del dev "$iface" ingress &>/dev/null || true
done
tc qdisc del dev "$IFB_DEV" root &>/dev/null || true


# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤
mapfile -t conf_files < <(find "${CONFIG_DIR}" -maxdepth 1 -name "port-*.conf" -type f | sort)
if [[ ${#conf_files[@]} -eq 0 ]]; then
    log "ü§∑ –ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥–æ–≤."
    exit 0
fi
log "üìÅ –ù–∞–π–¥–µ–Ω–æ ${#conf_files[@]} –∫–æ–Ω—Ñ–∏–≥–æ–≤."


# 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ IFB
ip link set dev "$IFB_DEV" up &>/dev/null || true


# 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–Ω–µ–≤—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω
declare -A handled_ifaces
for conf_file in "${conf_files[@]}"; do
    source "$conf_file"
    if [[ -z "${handled_ifaces[$IFACE]:-}" ]]; then
        log "üåê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è $IFACE..."
        
        run_tc tc qdisc add dev "$IFACE" root handle 1: htb default 9999
        run_tc tc class add dev "$IFACE" parent 1: classid 1:9999 htb rate 10gbit
        
        run_tc tc qdisc add dev "$IFACE" handle ffff: ingress
        run_tc tc filter add dev "$IFACE" parent ffff: protocol ip prio 1 u32 \
            match u32 0 0 action mirred egress redirect dev "$IFB_DEV"
        
        handled_ifaces[$IFACE]=1
    fi
done


if ! tc qdisc show dev "$IFB_DEV" | grep -q "htb"; then
    run_tc tc qdisc add dev "$IFB_DEV" root handle 2: htb default 9999
    run_tc tc class add dev "$IFB_DEV" parent 2: classid 2:9999 htb rate 10gbit
fi


# 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
PORT_IDX=1

for conf_file in "${conf_files[@]}"; do
    source "$conf_file"
    
    PORT_TOTAL_LIMIT="${TOTAL_LIMIT:-10000mbit}"
    MAX_USERS="${MAX_USERS:-256}"
    
    DL_PARENT_MINOR=$((0x10 * PORT_IDX))
    DL_BUCKET_BASE=$((0x1000 * PORT_IDX))
    DL_HASH_HANDLE=$(printf "%x" $((0x100 + PORT_IDX)))
    
    UL_PARENT_MINOR=$((0x20 * PORT_IDX))
    UL_BUCKET_BASE=$((0x2000 * PORT_IDX))
    UL_HASH_HANDLE=$(printf "%x" $((0x200 + PORT_IDX)))
    
    log "üîå –ü–æ—Ä—Ç $PORT –Ω–∞ $IFACE (Idx:$PORT_IDX)"
    log "   DL: Parent=1:$(printf %x $DL_PARENT_MINOR), Buckets=$(printf %x $DL_BUCKET_BASE)-$(printf %x $((DL_BUCKET_BASE + 255)))"
    log "   UL: Parent=2:$(printf %x $UL_PARENT_MINOR), Buckets=$(printf %x $UL_BUCKET_BASE)-$(printf %x $((UL_BUCKET_BASE + 255)))"
    log "   –õ–∏–º–∏—Ç—ã: DL $DOWN_LIMIT / UL $UP_LIMIT (Max: $MAX_USERS, Total: $PORT_TOTAL_LIMIT)"


    # ============================================================ 
    # DOWNLOAD (EGRESS)
    # ============================================================    
    run_tc tc class add dev "$IFACE" parent 1: classid "1:$(printf %x $DL_PARENT_MINOR)" \
        htb rate "$PORT_TOTAL_LIMIT" ceil "$PORT_TOTAL_LIMIT" quantum $PARENTQUANTUM
    
    run_tc tc filter add dev "$IFACE" parent 1: protocol ip prio 1 \
        handle "${DL_HASH_HANDLE}:" u32 divisor 256
    
    run_tc tc filter add dev "$IFACE" parent 1: protocol ip prio 1 u32 \
        match ip sport "$PORT" 0xffff \
        hashkey mask 0x000000ff at 16 \
        link "${DL_HASH_HANDLE}:"
    
    for bucket in $(seq 0 $((MAX_USERS - 1))); do
        CLASS_ID_DEC=$((DL_BUCKET_BASE + bucket))
        CLASS_ID="1:$(printf %x $CLASS_ID_DEC)"
        BUCKET_HEX=$(printf "%02x" $bucket)
        
        run_tc tc class add dev "$IFACE" parent "1:$(printf %x $DL_PARENT_MINOR)" \
            classid "$CLASS_ID" $(generate_htb_params "download" "$DOWN_LIMIT")
        
        run_tc tc qdisc add dev "$IFACE" parent "$CLASS_ID" $(generate_sfq_params)
        
        run_tc tc filter add dev "$IFACE" parent 1: protocol ip prio 1 u32 \
            ht "${DL_HASH_HANDLE}:${BUCKET_HEX}:" \
            match ip dst 0.0.0.0/0 \
            flowid "$CLASS_ID"
    done


        # ============================================================ 
        # UPLOAD (INGRESS –Ω–∞ IFB)
        # ============================================================    
        run_tc tc class add dev "$IFB_DEV" parent 2: classid "2:$(printf %x $UL_PARENT_MINOR)" \
            htb rate "$PORT_TOTAL_LIMIT" ceil "$PORT_TOTAL_LIMIT" quantum $PARENTQUANTUM
        
        run_tc tc filter add dev "$IFB_DEV" parent 2: protocol ip prio 1 \
            handle "${UL_HASH_HANDLE}:" u32 divisor 256
        
        run_tc tc filter add dev "$IFB_DEV" parent 2: protocol ip prio 1 u32 \
            match ip dport "$PORT" 0xffff \
            hashkey mask 0x000000ff at 12 \
            link "${UL_HASH_HANDLE}:"
        
        for bucket in $(seq 0 $((MAX_USERS - 1))); do
            CLASS_ID_DEC=$((UL_BUCKET_BASE + bucket))
            CLASS_ID="2:$(printf %x $CLASS_ID_DEC)"
            BUCKET_HEX=$(printf "%02x" $bucket)
            
            run_tc tc class add dev "$IFB_DEV" parent "2:$(printf %x $UL_PARENT_MINOR)" \
                classid "$CLASS_ID" $(generate_htb_params "upload" "$UP_LIMIT")
            
            run_tc tc qdisc add dev "$IFB_DEV" parent "$CLASS_ID" $(generate_sfq_params)
            
            run_tc tc filter add dev "$IFB_DEV" parent 2: protocol ip prio 1 u32 \
                ht "${UL_HASH_HANDLE}:${BUCKET_HEX}:" \
                match ip src 0.0.0.0/0 \
                flowid "$CLASS_ID"
        done


        PORT_IDX=$((PORT_IDX + 1))
    done


log "‚úÖ –ü—Ä–∞–≤–∏–ª–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
EOF
}

_tl_generate_systemd_service() {
    cat << EOF
[Unit]
Description=Reshala Traffic Limiter Service
After=network.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=${TL_APPLY_SCRIPT_PATH}
RemainAfterExit=yes
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
}
